<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AF1CESTREAM</title>
    <style>
        :root {
            --oro: #ffc107;
            --negro: #080808;
            --tarjeta: rgba(30, 30, 30, 0.95);
        }

        body { 
            background: #000;
            color: white; 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0; 
        }

        .header {
            position: sticky; 
            top: 0; 
            background: var(--negro);
            padding: 10px;
            border-bottom: 2px solid var(--oro);
            text-align: center;
            z-index: 100;
        }

        .logo { width: 30px; height: 30px; vertical-align: middle; }
        .title { font-size: 18px; color: var(--oro); display: inline; margin-left: 10px; }

        .download-buttons { 
            display: flex; 
            gap: 5px; 
            justify-content: center; 
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .list-btn {
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 9px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 1px solid #555;
            color: white; 
            background: #222;
            text-transform: uppercase;
        }

        .list-btn.active {
            background: var(--oro);
            color: var(--negro);
        }

        #search {
            width: 90%;
            margin: 10px auto;
            display: block;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: white;
        }

        .main-content { padding: 10px; }
        
        .grid { 
            display: none; /* Oculto hasta que se cargue */
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 8px; 
        }
        
        .grid.active { display: grid; } /* Mostrar cuando active */
        
        .channel-item {
            background: var(--tarjeta);
            border-radius: 8px;
            text-align: center;
            border: 1px solid transparent;
            transition: border 0.3s;
        }
        
        .channel-item:hover {
            border-color: var(--oro);
        }
        
        .channel-link {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: white;
        }
        
        .channel-logo {
            width: 40px;
            height: 40px;
            display: block;
            margin: 0 auto 5px;
        }
        
        .channel-name {
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status {
            text-align: center;
            padding: 50px;
            color: var(--oro);
            font-size: 14px;
        }

        .error {
            color: #ff4444;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <img src="https://i.postimg.cc/hPgpp1t3/1768043171823-removebg-preview.png" alt="Logo" class="logo">
        <span class="title">AF1CESTREAM</span>
    </div>
    
    <div class="download-buttons">
        <button class="list-btn active" onclick="loadList('acex')">Canales Acex</button>
        <button class="list-btn" onclick="loadList('events')">Eventos Acex</button>
        <button class="list-btn" onclick="loadList('pre')">Canales Pre</button>
        <button class="list-btn" onclick="loadList('pre-events')">Eventos Pre</button>
        <button class="list-btn" onclick="loadList('vpn')">VPN</button>
    </div>
    
    <input type="text" id="search" placeholder="BUSCAR CANAL..." onkeyup="filterChannels()">
</div>

<div class="main-content">
    <div id="loading" class="status">CARGANDO LISTA...</div>
    <div id="channel-list" class="grid"></div>
    <div id="error-display" class="error" style="display:none;"></div>
</div>

<script>
    const LOGO = 'https://i.postimg.cc/hPgpp1t3/1768043171823-removebg-preview.png';
    
    // DATOS INCORPORADOS (fallback si fetch falla)
    const FALLBACK_CHANNELS = [
        {name: "EJEMPLO 1", link: "https://example.com/stream1.m3u8", type: "web"},
        {name: "EJEMPLO 2", link: "acestream://1234567890abcdef", type: "ace"}
    ];

    let allChannels = [];
    let currentList = 'acex';

    function showStatus(msg) {
        document.getElementById('loading').textContent = msg;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('channel-list').style.display = 'none';
        document.getElementById('error-display').style.display = 'none';
    }

    function showError(msg) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('channel-list').style.display = 'none';
        const errorEl = document.getElementById('error-display');
        errorEl.style.display = 'block';
        errorEl.innerHTML = `<b>⚠️ ERROR:</b> ${msg}<br><br><small>Prueba otra lista o usa el botón ATRÁS</small>`;
        loadFallback();
    }

    function render() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-display').style.display = 'none';
        document.getElementById('channel-list').classList.add('active');
        
        const html = allChannels.map(c => {
            let url = c.link.trim();
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop().split('?')[0];
                url = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0`;
            }

            return `
                <div class="channel-item">
                    <a href="${url}" 
                       class="channel-link" 
                       target="_blank" 
                       rel="noreferrer">
                        <img src="${LOGO}" alt="" class="channel-logo">
                        <div class="channel-name">${c.name}</div>
                    </a>
                </div>
            `;
        }).join('');
        
        document.getElementById('channel-list').innerHTML = html;
    }

    function loadFallback() {
        allChannels = FALLBACK_CHANNELS;
        render();
    }

    async function loadList(listName) {
        currentList = listName;
        allChannels = [];
        showStatus(`Cargando ${listName}...`);
        
        // Desactivar botones mientras carga
        document.querySelectorAll('.list-btn').forEach(btn => btn.disabled = true);
        
        try {
            let url;
            switch(listName) {
                case 'acex':
                    url = 'https://raw.githubusercontent.com/Icastresana/lista1/refs/heads/main/Probando';
                    break;
                case 'events':
                    url = 'https://raw.githubusercontent.com/Icastresana/lista1/main/eventos.m3u';
                    break;
                case 'pre':
                    url = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/lista_canales_DEPORTE-LIBRE.FANS.xml';
                    break;
                case 'pre-events':
                    url = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/eventos_livetv_sx_con_reproductores.xml';
                    break;
                case 'vpn':
                    url = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/lista_sportsonlineci.xml';
                    break;
            }

            console.log(`Cargando: ${url}`);
            
            // Timeout de 15 segundos
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch(url, { 
                signal: controller.signal,
                method: 'GET',
                mode: 'cors'
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const text = await response.text();
            console.log(`Descargado: ${text.substring(0, 100)}...`);
            
            // Parsear según tipo
            if (url.endsWith('.m3u')) {
                parseM3U(text);
            } else {
                parseXML(text, listName);
            }
            
        } catch (err) {
            console.error("Error:", err);
            showError(`Falló carga: ${err.message}`);
        } finally {
            // Reactivar botones
            document.querySelectorAll('.list-btn').forEach(btn => btn.disabled = false);
        }
    }

    function parseM3U(text) {
        const lines = text.split('\n');
        let count = 0;
        
        // Limpiar y validar
        const cleanLines = lines.filter(line => line.trim() !== '');
        
        cleanLines.forEach((line, i) => {
            if (line.startsWith('#EXTINF:')) {
                const parts = line.split(',');
                const name = parts[1]?.trim() || 'Sin nombre';
                const link = cleanLines[i+1]?.trim();
                
                if (name && link && !link.startsWith('#') && link !== '') {
                    allChannels.push({ name: name, link: link, type: 'web' });
                    count++;
                }
            }
        });
        
        if (count === 0) throw new Error("M3U vacío o formato inválido");
        render();
    }

    function parseXML(text, listName) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(text, "text/xml");
        
        const parseError = xmlDoc.getElementsByTagName("parsererror");
        if (parseError.length > 0) {
            console.error("XML Parse Error:", parseError[0].textContent);
            throw new Error("Formato XML inválido");
        }
        
        let count = 0;
        
        if (listName === 'pre') {
            const items = xmlDoc.querySelectorAll('channel, canal');
            console.log(`Found ${items.length} channel items`);
            items.forEach(item => {
                const name = item.getAttribute('name') || item.getAttribute('nombre') || 'Sin nombre';
                const url = item.querySelector('url')?.textContent;
                if (name && url && url.trim() !== '') {
                    allChannels.push({ name: name.trim(), link: url.trim(), type: 'web' });
                    count++;
                }
            });
        } else if (listName === 'pre-events') {
            const events = xmlDoc.getElementsByTagName("evento");
            Array.from(events).forEach(ev => {
                const nombre = ev.getElementsByTagName("nombre")[0]?.textContent;
                const stream = ev.getElementsByTagName("stream")[0];
                const url = stream?.getElementsByTagName("url")[0]?.textContent;
                if (nombre && url && url.trim() !== '') {
                    allChannels.push({ name: nombre.trim(), link: url.trim(), type: 'web' });
                    count++;
                }
            });
        } else if (listName === 'vpn') {
            const tracks = xmlDoc.getElementsByTagName("track");
            Array.from(tracks).forEach(t => {
                const name = t.getElementsByTagName("title")[0]?.textContent;
                const urls = t.getElementsByTagName("url");
                if (name && urls.length > 0 && urls[0].textContent.trim() !== '') {
                    allChannels.push({ name: name.trim(), link: urls[0].textContent.trim(), type: 'web' });
                    count++;
                }
            });
        }
        
        if (count === 0) throw new Error(`No se encontraron canales en ${listName}`);
        render();
    }

    function filterChannels() {
        const q = document.getElementById('search').value.toLowerCase();
        const filtered = allChannels.filter(c => c.name.toLowerCase().includes(q));
        
        const html = filtered.map(c => {
            let url = c.link.trim();
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop().split('?')[0];
                url = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0`;
            }

            return `
                <div class="channel-item">
                    <a href="${url}" 
                       class="channel-link" 
                       target="_blank" 
                       rel="noreferrer">
                        <img src="${LOGO}" alt="" class="channel-logo">
                        <div class="channel-name">${c.name}</div>
                    </a>
                </div>
            `;
        }).join('');
        
        document.getElementById('channel-list').innerHTML = html;
    }

    // Cargar lista inicial al abrir
    loadList('acex');
</script>
</body>
</html>
