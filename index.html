<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AF1CESTREAM</title>
    <style>
        :root {
            --oro: #ffc107;
            --oro-glow: rgba(255, 193, 7, 0.8);
            --negro: #080808;
            --tarjeta: rgba(30, 30, 30, 0.95);
        }

        body { 
            background: #000;
            color: white; 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0; 
        }

        .header {
            position: sticky; 
            top: 0; 
            background: var(--negro);
            padding: 10px;
            border-bottom: 2px solid var(--oro);
            text-align: center;
            z-index: 100;
        }

        .logo { width: 30px; height: 30px; filter: drop-shadow(0 0 5px var(--oro)); vertical-align: middle; }
        .title { font-size: 18px; color: var(--oro); display: inline; margin-left: 10px; }

        .download-buttons { 
            display: flex; 
            gap: 5px; 
            justify-content: center; 
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .list-btn {
            padding: 5px 8px; 
            border-radius: 4px; 
            font-size: 9px; 
            font-weight: bold; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.2);
            color: white; 
            background: #333;
            text-transform: uppercase;
        }

        .list-btn.active {
            background: var(--oro);
            color: var(--negro);
        }

        #search {
            width: 90%;
            margin: 10px auto;
            display: block;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .main-content { padding: 10px; }
        
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 8px; 
        }
        
        .channel-item {
            background: var(--tarjeta);
            border-radius: 8px;
            text-align: center;
            overflow: hidden;
            border: 1px solid transparent;
            transition: border-color 0.3s;
        }
        
        .channel-item:hover {
            border-color: var(--oro);
        }
        
        .channel-link {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: white;
        }
        
        .channel-logo {
            width: 40px;
            height: 40px;
            display: block;
            margin: 0 auto 5px;
        }
        
        .channel-name {
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: var(--oro);
        }

        .error {
            color: #ff4444;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <img src="https://i.postimg.cc/hPgpp1t3/1768043171823-removebg-preview.png" alt="Logo" class="logo">
        <span class="title">AF1CESTREAM</span>
    </div>
    
    <div class="download-buttons">
        <button class="list-btn active" onclick="loadM3U(MAIN_M3U, true, this)">Canales Acex</button>
        <button class="list-btn" onclick="loadM3U(EVENTS_M3U, true, this)">Eventos Acex</button>
        <button class="list-btn" onclick="loadXML_Ev2(this)">Canales Pre</button>
        <button class="list-btn" onclick="loadXML_Ev3(this)">Eventos Pre</button>
        <button class="list-btn" onclick="loadXML_Ev4(this)">Pre + VPN</button>
    </div>
    
    <input type="text" id="search" placeholder="BUSCAR CANAL..." onkeyup="filter()">
</div>

<div class="main-content">
    <div id="loading" class="status">CARGANDO LISTA...</div>
    <div id="channel-list" class="grid"></div>
    <div id="error-display" class="error" style="display:none;"></div>
</div>

<script>
    const MAIN_M3U = 'https://raw.githubusercontent.com/Icastresana/lista1/refs/heads/main/Probando';
    const EVENTS_M3U = 'https://raw.githubusercontent.com/Icastresana/lista1/main/eventos.m3u';
    const XML_EV2 = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/lista_canales_DEPORTE-LIBRE.FANS.xml';
    const XML_EV3 = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/eventos_livetv_sx_con_reproductores.xml';
    const XML_EV4 = 'https://raw.githubusercontent.com/tutw/platinsport-m3u-updater/refs/heads/main/lista_sportsonlineci.xml';
    const LOGO = 'https://i.postimg.cc/hPgpp1t3/1768043171823-removebg-preview.png';

    let channels = [];

    function showLoading() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('channel-list').style.display = 'none';
        document.getElementById('error-display').style.display = 'none';
    }

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('channel-list').style.display = 'none';
        const errorDisplay = document.getElementById('error-display');
        errorDisplay.style.display = 'block';
        errorDisplay.innerHTML = `<b>ERROR:</b> ${message}<br><br><small>Pulsa ATRÁS en tu dispositivo para volver</small>`;
    }

    function render() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-display').style.display = 'none';
        document.getElementById('channel-list').style.display = 'grid';
        
        // CRÍTICO: Generar ENLACES DIRECTOS <a> para Wiseplay
        const html = channels.map((c, i) => {
            let url = c.link.trim();
            
            // Skip URLs vacías
            if (!url || url === '') {
                console.warn(`Canal sin URL: ${c.name}`);
                return '';
            }
            
            console.log(`Generando enlace: ${c.name} -> ${url.substring(0, 60)}...`);
            
            // Manejo YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop().split('?')[0];
                url = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0`;
            }

            return `
                <div class="channel-item">
                    <a href="${url}" 
                       class="channel-link" 
                       target="_blank" 
                       rel="noreferrer">
                        <img src="${LOGO}" alt="Logo" class="channel-logo">
                        <div class="channel-name">${c.name}</div>
                    </a>
                </div>
            `;
        }).join('');
        
        document.getElementById('channel-list').innerHTML = html;
    }

    function loadM3U(u, f, el) {
        setActive(el);
        channels = [];
        showLoading();
        
        fetch(u)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            })
            .then(t => {
                const l = t.split('\n');
                let count = 0;
                l.forEach((line, i) => {
                    if (line.startsWith('#EXTINF:')) {
                        const name = line.split(',')[1]?.trim() || 'Sin nombre';
                        const link = l[i+1]?.trim();
                        if (name && link && link !== '') {
                            channels.push({ name: name, link: link, type: f ? 'ace' : 'web' });
                            count++;
                        }
                    }
                });
                
                if (count === 0) showError("Lista M3U vacía");
                else render();
            })
            .catch(err => showError(`Error M3U: ${err.message}`));
    }

    function loadXML_Ev2(el) {
        setActive(el);
        channels = [];
        showLoading();
        
        fetch(XML_EV2)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            })
            .then(t => {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(t, "text/xml");
                
                const parseError = xmlDoc.getElementsByTagName("parsererror");
                if (parseError.length > 0) throw new Error("XML corrupto");
                
                const items = xmlDoc.querySelectorAll('channel, canal');
                if (items.length === 0) throw new Error("No hay elementos <channel> o <canal>");
                
                let count = 0;
                items.forEach(item => {
                    const name = item.getAttribute('name') || item.getAttribute('nombre') || 'Sin nombre';
                    const url = item.querySelector('url')?.textContent;
                    if (name && url && url.trim() !== '') {
                        channels.push({ name: name.trim(), link: url.trim(), type: 'web' });
                        count++;
                    }
                });
                
                if (count === 0) showError("No se encontraron canales válidos");
                else render();
            })
            .catch(err => showError(`Error Canales Pre: ${err.message}`));
    }

    function loadXML_Ev3(el) {
        setActive(el);
        channels = [];
        showLoading();
        
        fetch(XML_EV3)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            })
            .then(t => {
                const x = new DOMParser().parseFromString(t, "text/xml");
                
                const parseError = x.getElementsByTagName("parsererror");
                if (parseError.length > 0) throw new Error("XML corrupto");
                
                const events = x.getElementsByTagName("evento");
                if (events.length === 0) throw new Error("No hay elementos <evento>");
                
                let count = 0;
                Array.from(events).forEach(ev => {
                    const nombre = ev.getElementsByTagName("nombre")[0]?.textContent;
                    const stream = ev.getElementsByTagName("stream")[0];
                    const url = stream?.getElementsByTagName("url")[0]?.textContent;
                    if (nombre && url && url.trim() !== '') {
                        channels.push({ name: nombre.trim(), link: url.trim(), type: 'web' });
                        count++;
                    }
                });
                
                if (count === 0) showError("No se encontraron eventos válidos");
                else render();
            })
            .catch(err => showError(`Error Eventos Pre: ${err.message}`));
    }

    function loadXML_Ev4(el) {
        setActive(el);
        channels = [];
        showLoading();
        
        fetch(XML_EV4)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            })
            .then(data => {
                const x = new DOMParser().parseFromString(data, "text/xml");
                
                const parseError = x.getElementsByTagName("parsererror");
                if (parseError.length > 0) throw new Error("XML corrupto");
                
                const tracks = x.getElementsByTagName("track");
                if (tracks.length === 0) throw new Error("No hay elementos <track>");
                
                let count = 0;
                Array.from(tracks).forEach(t => {
                    const name = t.getElementsByTagName("title")[0]?.textContent;
                    const urls = t.getElementsByTagName("url");
                    if (name && urls.length > 0 && urls[0].textContent.trim() !== '') {
                        channels.push({ name: name.trim(), link: urls[0].textContent.trim(), type: 'web' });
                        count++;
                    }
                });
                
                if (count === 0) showError("No se encontraron canales VPN");
                else render();
            })
            .catch(err => showError(`Error VPN: ${err.message}`));
    }

    function filter() {
        const q = document.getElementById('search').value.toLowerCase();
        const f = channels.filter(c => c.name.toLowerCase().includes(q));
        
        const list = document.getElementById('channel-list');
        list.innerHTML = f.map((c, i) => {
            let url = c.link.trim();
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop().split('?')[0];
                url = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1&rel=0`;
            }

            return `
                <div class="channel-item">
                    <a href="${url}" 
                       class="channel-link" 
                       target="_blank" 
                       rel="noreferrer">
                        <img src="${LOGO}" alt="Logo" class="channel-logo">
                        <div class="channel-name">${c.name}</div>
                    </a>
                </div>
            `;
        }).join('');
    }

    // Cargar lista inicial
    loadM3U(MAIN_M3U, true, document.querySelector('.list-btn.active'));
</script>
</body>
</html>
